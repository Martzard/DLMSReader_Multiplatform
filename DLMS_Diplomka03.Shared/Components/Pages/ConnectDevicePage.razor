@page "/connect-device/{DeviceName}"
@using DLMS_Diplomka03.Shared.Components.Models
@using DLMS_Diplomka03.Shared.Components.ViewModels
@using Gurux.DLMS.Objects
@inject DeviceDataViewModel ViewModel
@inject NavigationManager Nav

<div style="display:flex;flex-direction:column;height:100vh;">
    <!-- Horní část -->
    <div style="flex:1;display:flex;overflow:hidden;">
        <!-- Levý panel -->
        <div style="width:250px;background:#f9f9f9;border-right:1px solid #ccc;display:flex;flex-direction:column;">
            <div style="padding:10px;border-bottom:1px solid #ccc;">
                <button @onclick="ReadAllObjects"
                        style="width:100%;margin-bottom:5px;background:mediumseagreen;color:#fff;border:none;padding:8px;border-radius:5px;">
                    Načíst objekty
                </button>
                <button @onclick="@(() => Nav.NavigateTo("/"))"
                        style="width:100%;background:firebrick;color:#fff;border:none;padding:8px;border-radius:5px;">
                    Zpět
                </button>
                <h5 style="margin:8px 0 0 0;">Objekty</h5>
            </div>

            <div style="padding:10px;overflow-y:auto;flex-grow:1;">
                @if (connectionVM?.Device.DeviceObjects?.Count == 0)
                {
                    <p><em>Žádné objekty zatím nebyly načteny.</em></p>
                }
                else
                {
                    <ul class="device-list">
                        @foreach (var obj in connectionVM!.Device.DeviceObjects)
                        {
                            <li @onclick="() => SelectObject(obj)"
                                class="@(connectionVM.SelectedObject == obj ? "selected" : "")">
                                <strong>@obj.LogicalName</strong><br />
                                <small>@obj.Description</small>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>

        <!-- Pravý panel -->
        <div style="flex-grow:1;padding:20px;overflow-y:auto;">
            @if (connectionVM?.Device.InterfaceType == Gurux.DLMS.Enums.InterfaceType.WRAPPER)
            {
                <h4>@($"{connectionVM?.Device.Name}, {connectionVM?.Device.InterfaceType}, {connectionVM?.Device.ServerAddress}:{connectionVM?.Device.Port}")</h4>
            }

            @if (connectionVM?.SelectedObject != null)
            {
                <pre>@connectionVM.ObjectDetailsString</pre>
            }
            else
            {
                <p><em>Vyber objekt ze seznamu vlevo.</em></p>
            }
        </div>
    </div>
</div>

<style>
    .device-list { list-style:none;padding:0;margin:0; }
    .device-list li {
        padding:10px;border:1px solid #ccc;margin-bottom:5px;border-radius:6px;
        cursor:pointer;transition:background .2s ease;
    }
    .device-list li:hover { background:#f1f1f1; }
    .device-list li.selected { background:#d0ebff;border-color:#74c0fc; }
</style>

@code {
    [Parameter] public string DeviceName { get; set; } = "";

    private DeviceConnectionViewModel? connectionVM;

    protected override void OnInitialized()
    {
        var device = ViewModel.AllDevices.FirstOrDefault(d => d.Name == DeviceName);
        if (device != null)
            connectionVM = new DeviceConnectionViewModel(device);   // bez DbService
        else
            Nav.NavigateTo("/");
    }

    private async Task ReadAllObjects()
    {
        if (connectionVM != null)
        {
            await connectionVM.ConnectToDeviceAsync();
            StateHasChanged();
        }
    }

    private void SelectObject(GXDLMSObject obj)
    {
        if (connectionVM != null)
        {
            connectionVM.SelectedObject = obj;
            connectionVM.GetSelectedObjectText();
        }
    }
}
